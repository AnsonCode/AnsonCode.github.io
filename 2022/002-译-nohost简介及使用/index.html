<!DOCTYPE html>
<html lang="zh-cn">
    <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noodp"/>
    <meta name="author" content="Anson">
    <meta name="description" content="anson会写代码的产品经理，这是我的技术博客，专注产品设计及软件开发。">
    <meta name="keywords" content="golang;PMP">
    
    <link rel="prev" href="http://ansoncode.bazhentu.net/2022/001-%E8%AF%91-hasura%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/" />
    <link rel="next" href="http://ansoncode.bazhentu.net/2022/003-%E8%AF%91-graphql%E5%88%B0sql%E9%AB%98%E6%80%A7%E8%83%BD%E6%9E%B6%E6%9E%84/" />
    <link rel="canonical" href="http://ansoncode.bazhentu.net/2022/002-%E8%AF%91-nohost%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BD%BF%E7%94%A8/" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <title>
        
        
            002 译 | Nhost简介及使用 | Anson`s Blog
        
    </title>
    <meta name="title" content="002 译 | Nhost简介及使用 | Anson`s Blog">
    
<link rel="stylesheet" href="/css/main.min.css">


    
    
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "http:\/\/ansoncode.bazhentu.net\/"
    },
    "articleSection" : "posts",
    "name" : "002 译 | Nhost简介及使用",
    "headline" : "002 译 | Nhost简介及使用",
    "description" : "1. 欢迎来到 Nhost Nhost 是一个开源的，实时，无服务的后端平台，能够构建可靠的应用，去扩大你的商业规模。 组件 Nhost 构建在一系列开源组件之上。 数据库 你的应用程",
    "inLanguage" : "zh-cn",
    "author" : "Anson",
    "creator" : "Anson",
    "publisher": "Anson",
    "accountablePerson" : "Anson",
    "copyrightHolder" : "Anson",
    "copyrightYear" : "2022",
    "datePublished": "2022-02-01 11:59:39 \u002b0800 CST",
    "dateModified" : "2022-02-01 11:59:39 \u002b0800 CST",
    "url" : "http:\/\/ansoncode.bazhentu.net\/2022\/002-%E8%AF%91-nohost%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BD%BF%E7%94%A8\/",
    "wordCount" : "5792",
    "keywords" : [ "技术翻译","Hasura","Nhost", "Anson`s Blog"]
}
</script>

  </head>
    <body class="">
        <div class="wrapper">
            <nav class="navbar">
    
        <progress class="content_progress" max="0" value="0"></progress>
    
    <div class="container">
        
            <div class="navbar-header header-back2home-logo">
                <span class="logo_mark" >>$</span>
                <a href="http://ansoncode.bazhentu.net/">
                    <span class="logo_text" >cd /home/</span>
                    <span class="logo_cursor" ></span>
                </a>
            </div>
        
        <div class="navbar-right">
                
                <span class="menu">
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <span class="divide"></span>
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a>
                </span>
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <progress class="content_progress" max="0" value="0"></progress>
    
     <div class="container">
        <div class="navbar">
            <div class="navbar-header header-logo">
                    <a href="http://ansoncode.bazhentu.net/">Anson`s Blog</a>
            </div>
            <div class="navbar-right">
                <div><a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a></div>
                <div class="menu-toggle">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                <nav class="mb-md">
                    
                    
                        <a class="menu-item" href="/posts/" title="">
                            <h3>Blog</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/categories/" title="">
                            <h3>Categories</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/tags/" title="">
                            <h3>Tags</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/about/" title="">
                            <h3>About</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                </nav>
        </div>
    </div>
</nav>
            <main class="main">
                <div class="container">
                    
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">002 译 | Nhost简介及使用</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="http://ansoncode.bazhentu.net/" rel="author">Anson</a> with ♥
                <span class="post-time">
                on <time datetime=2022-02-01 itemprop="datePublished">February 1, 2022</time>
                </span>
                in
                
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        
                        
                        
                          <a href="http://ansoncode.bazhentu.net/categories/%E7%A0%94%E5%8F%91%E6%8F%90%E6%95%88/"> 研发提效, </a>
                        
                        
                </span>
                <span class="post-word-count">5792 words</span>
        </div>
    </header>

    <div class="post-content">
        

        
        
            
        

        
        
        
        
        

        
        
        

        <h1 id="1-欢迎来到-nhost">1. 欢迎来到 Nhost</h1>
<p>Nhost 是一个开源的，实时，无服务的后端平台，能够构建可靠的应用，去扩大你的商业规模。</p>
<h3 id="组件">组件</h3>
<p>Nhost 构建在一系列开源组件之上。</p>
<p><strong>数据库</strong></p>
<p>你的应用程序有自己的 PostgreSQL 数据库，这个世界上最先进的关系数据库。</p>
<p><strong>GraphQL API</strong>
基于 Hasura 的高性能、实时 GraphQL API</p>
<p><strong>鉴权和存储</strong>
用户管理和文件存储与 Hasura 权限无缝集成</p>
<p><strong>无服务函数</strong></p>
<p>在后端用 JavaScript 和 TypeScript 函数运行自定义代码</p>
<h3 id="开始">开始</h3>
<p>跟着我们的<a href="https://docs.nhost.io/get-started/quick-start">快速开始</a>指导去构建你的第一个应用。</p>
<p>核查<a href="https://github.com/nhost/nhost">Nhost Github</a>。给我们一个星星，并尽情讨论任何特性需求。</p>
<h1 id="2-快速启动">2. 快速启动</h1>
<h1 id="21-创建你的应用">2.1 创建你的应用</h1>
<p>让我们使用 Nhost 创建一个简单的 todo(待做事项)应用。在一个待做事项应用中，一个用户应该能为他们的账户创建列表项（CRUD），并且没有其他任何人看到他们（权限）。</p>
<p>为了在 Nhost 实现一个像这样的应用，我们简单介绍这些主题：</p>
<ul>
<li>在 Nhost 创建一个新的应用</li>
<li>定义数据库 schema</li>
<li>插入数据</li>
<li>设置权限</li>
<li>通过 GraphQL API 查询数据</li>
</ul>
<p>在它的结尾，但愿你有一个更好的理解关于 Nhost 是什么，以及它能为你做什么。</p>
<h3 id="登录-nhost">登录 Nhost</h3>
<p>如果你之前没有账户，前往<a href="https://app.nhost.io/">happ.nhost.io</a>注册一个新账户。</p>
<p>登录并跳转到 Nhost 控制面板。</p>
<h3 id="创建应用">创建应用</h3>
<p>在控制面板的主页，点击“新建应用”按钮。填写名字并且选择一个靠近你用户地区域。你将使用默认空间和免费计划完成设置。</p>
<p><img src="https://docs.nhost.io/images/quick-start/new-app.png" alt="new app" loading="lazy" ></p>
<p>设置新的应用将花费大约 20 秒。在这期间，Nhost 将为你的应用设置好全部的基础架构。</p>
<p>一旦启动完成，你将自动看到控制面板，然后你就可以去定义你的应用数据库 schema 了。</p>
<h1 id="22-定义-schema">2.2 定义 schema</h1>
<p>为了实现一个管理待做事项的应用，让我们确保我们有存储待做事项和用户地数据库表。</p>
<h3 id="打开-hasura-控制台">打开 Hasura 控制台</h3>
<p>Hasura 生成实时 GraphQL APIs，但是它也提供一个网络控制台管理 schema 和数据库数据。</p>
<p>在你的 APP 面板，前往<strong>数据</strong>页签，并且选择<strong>打开 Hasura</strong>。记得去复制这个管理员秘钥。</p>
<p>你 APP 的 Hasura 控制台将在一个新的页签中打开。你可以使用 Hasura 控制台去管理你的应用 schema、数据、权限和时间触发。</p>
<p><img src="https://docs.nhost.io/images/quick-start/data-tab.png" alt="DATA->OPEN Hasura" loading="lazy" ></p>
<h3 id="用户表">用户表</h3>
<p>你应该能在屏幕左侧看到你的所有数据表。你应该看到多个不同的像文件夹一样展示的<strong>schemas</strong>。</p>
<ul>
<li>你 APP 自定义表的公共 schema</li>
<li>NHost 的用户管理和文件存储 schema</li>
</ul>
<p>如果你打开<strong>auth</strong>schema，将看到你的 app 早已经有用户表了，所以你不需要创建一个。</p>
<p><img src="https://docs.nhost.io/images/quick-start/list-of-schemas.png" alt="To store the users, we already have a users table from the auth schema" loading="lazy" ></p>
<h3 id="创建-todos-表">创建 TODOs 表</h3>
<p>在 Hasura 控制台中，去<strong>数据</strong>页签，然后点击<strong>创建表</strong>。命名这个表为<strong>todos</strong>。</p>
<p><strong>增加常用的列</strong></p>
<p><strong>id</strong>和<strong>created_at</strong>字段是很常见的，仅仅通过两次点击增加上。点击<strong>常用字段</strong>并且创建他们：</p>
<ul>
<li><strong>id</strong>(uuid)</li>
<li><strong>created_at</strong>(timestamp)</li>
</ul>
<p>这确保这些字段获得正确的命名、类型和默认值。</p>
<p><img src="https://docs.nhost.io/images/quick-start/frequently-used-columns.png" alt="Frequently used columns in the Hasura console" loading="lazy" ></p>
<p><strong>增加自定义字段</strong></p>
<p>手动增加另外两列字段</p>
<ul>
<li><strong>name</strong>(text)</li>
<li><strong>is_completed</strong>(boolean)</li>
</ul>
<p>确保设置<strong>is_completed</strong>的默认值为<strong>false</strong></p>
<p><img src="https://docs.nhost.io/images/quick-start/create-table.png" alt="Create a table in the Hasura console" loading="lazy" ></p>
<p>这是所有我们需要做的！当你点击<strong>增加表</strong>时，一个新的表将要被创建。</p>
<h3 id="插入数据">插入数据</h3>
<p>前往<strong>插入行</strong>页签为你的数据库增加一些数据。</p>
<p><img src="https://docs.nhost.io/images/quick-start/insert-todos.gif" alt="Inserting todos" loading="lazy" ></p>
<h3 id="查询数据">查询数据</h3>
<p>现在在我们的数据库中有了数据，我们可以通过 GraphQL API 检索他们。在主菜单中，前往<strong>API</strong>页签。这个页面可以用于执行 GraphQL 请求，查询或者变更数据库中的数据。</p>
<p>粘贴下面的 GraphQL 查询到表单中，点击“播放”按钮：</p>
<pre><code>query {
  todos {
    id
    created_at
    name
    is_completed
  }
}
</code></pre><p>你将在右侧看到你感兴趣的 todos（待做事项）输出。</p>
<h4 id="管理员角色">管理员角色</h4>
<p>上述请求的前提是：Hasura 控制台的所有请求都是<strong>管理员</strong>角色。</p>
<h1 id="23-javascript-客户端">2.3 JavaScript 客户端</h1>
<p>在前一个章节，你使用 Hasura 控制台查询了一列待做事项。现在，你将在你的 Nhost 应用中写一个小型的 JavaScript 客户端去集成和检索待做事项。</p>
<h4 id="前段框架">前段框架</h4>
<p>Nhost 是框架无关的，并且支持你想使用的任何前端。如果你想的话，也可以从你的服务端链接 Nhost。</p>
<p>在这个指南中，我们将保持例子简单。我们不使用前端框架。在一个真实的场景中，你或许将使用一个 React 、VUE、Svelte 或者 React Native 框架构建一个客户端。</p>
<h3 id="启动">启动</h3>
<p><em>注：确保你已经安装<a href="https://nodejs.org/en/">Node.js</a>和<a href="https://docs.npmjs.com/getting-started/">npm</a></em></p>
<p>创建一个新的文件夹叫做<strong>nhost-todos</strong>，并且初始化一个新的 JavaScript 应用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm init
</code></pre></div><p><em>注：你或许必须编辑<code>package.json</code>文件，并且增加或改变</em>type<em>对象为<code>module</code>（“type&quot;:&ldquo;module&rdquo;）</em></p>
<p>安装 Nhost JavaScript SDK:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install @nhost/nhost-js
</code></pre></div><h3 id="初始化-nhost">初始化 Nhost</h3>
<p>在新的文件夹中，创建叫做<strong>index.js</strong>的文件。</p>
<p>在文件中输入下列代码。它将初始化一个新的<strong>NhostClient</strong>，能够与你的后端交互：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">NhostClient</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@nhost/nhost-js&#34;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nhost</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">NhostClient</span>({
  <span style="color:#a6e22e">backendUrl</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;https://[app-subdomain].nhost.run&#34;</span>, <span style="color:#75715e">// replace this with the backend URL of your app
</span><span style="color:#75715e"></span>});

<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">nhost</span>.<span style="color:#a6e22e">graphql</span>.<span style="color:#a6e22e">getUrl</span>());
</code></pre></div><p>在你的命令行中运行代码。你将看到你应用的 GraphQL 端点 URL:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-BASH" data-lang="BASH">➜ node index.js

https://<span style="color:#f92672">[</span>app-subdomain<span style="color:#f92672">]</span>.nhost.run/v1/graphql
</code></pre></div><h3 id="查询-todos">查询 todos</h3>
<p>如果你现在增加下列的 GraphQL 查询到客户端，当你运行这个更新的版本时，让我们看将发生什么：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">NhostClient</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@nhost/nhost-js&#34;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nhost</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">NhostClient</span>({
  <span style="color:#a6e22e">backendUrl</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;https://[app-subdomain].nhost.run&#34;</span>,
})(<span style="color:#66d9ef">async</span> () =&gt; {
  <span style="color:#75715e">// nhost.graphql.request returns a promise, so we use await here
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">todos</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">nhost</span>.<span style="color:#a6e22e">graphql</span>.<span style="color:#a6e22e">request</span>(<span style="color:#e6db74">`
</span><span style="color:#e6db74">    query {
</span><span style="color:#e6db74">      todos {
</span><span style="color:#e6db74">        id
</span><span style="color:#e6db74">        created_at
</span><span style="color:#e6db74">        name
</span><span style="color:#e6db74">        is_completed
</span><span style="color:#e6db74">      }
</span><span style="color:#e6db74">    }
</span><span style="color:#e6db74">  `</span>);

  <span style="color:#75715e">// Print todos to console
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">todos</span>.<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">null</span>, <span style="color:#ae81ff">2</span>));
})();
</code></pre></div><pre><code class="language-console" data-lang="console">➜ node index.js

null
</code></pre><p><strong>null</strong>被输出。为什么是这样？让我们找到原因。</p>
<h1 id="24-设置权限">2.4 设置权限</h1>
<p>Hasura 支持角色权限控制。你为每一个角色、表和操作(select\insert\update\delte)创建规则，这会动态核查会话变量，例如用户 ID。</p>
<p>在上述部分，你能查询 todos，因为当使用 Hasura 控制台时，<strong>管理员</strong>角色默认开启。当构建你的应用时，你将想要使用角色定义权限，当执行请求时，你的用户假定的角色。</p>
<h2 id="未授权用户">未授权用户</h2>
<p>当你想要一些数据被任何不登录的用户访问时，在权限中使用<strong>public</strong>角色。在所有未授权请求中，这是默认角色。</p>
<p>通常说，这个<strong>public</strong>角色不应该有插入、更新或者删除的权限定义。</p>
<h3 id="设置公共权限">设置公共权限</h3>
<p>在 Hasura 控制台中，前往<strong>Data</strong>页签，点击<strong>todos</strong>表，然后点击<strong>授权</strong>。增加一个叫做<strong>public</strong>的新角色，点击<strong>选择</strong>。这个对于选择操作的权限选项将在下面打开。</p>
<p>增加下列的权限：</p>
<p><img src="https://docs.nhost.io/images/quick-start/permissions-public-select.png" alt="Public role" loading="lazy" ></p>
<p>如果你现在再运行程序一次，你将在输出中看到 todos：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜ node index.js

<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;todos&#34;</span>: <span style="color:#f92672">[</span>
    <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;558b9754-bb18-4abd-83d9-e9056934e812&#34;</span>,
      <span style="color:#e6db74">&#34;created_at&#34;</span>: <span style="color:#e6db74">&#34;2021-12-01T17:05:09.311362+00:00&#34;</span>,
      <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;write docs&#34;</span>,
      <span style="color:#e6db74">&#34;is_completed&#34;</span>: false
    <span style="color:#f92672">}</span>,
    <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;480369c8-6f57-4061-bfdf-9ead647e10d3&#34;</span>,
      <span style="color:#e6db74">&#34;created_at&#34;</span>: <span style="color:#e6db74">&#34;2021-12-01T17:05:20.5693+00:00&#34;</span>,
      <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;cook dinner&#34;</span>,
      <span style="color:#e6db74">&#34;is_completed&#34;</span>: true
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>

</code></pre></div><p>这有 2 个原因，为什么请求成功：</p>
<ul>
<li>Nhost 设置<strong>public</strong>角色为每个未授权 GraphQL 请求</li>
<li>你明确定义权限为<strong>public</strong>角色</li>
</ul>
<p>他是重要的去理解 Hasura 有一个<strong>默认禁用所有</strong>的策略确保仅仅你明确定义的角色和权限能被访问。</p>
<h1 id="3-授权用户">3. 授权用户</h1>
<p>在上述章节，你为<strong>public</strong>角色定义<strong>select</strong>权限。现在你将增加<strong>insert</strong>和<strong>create</strong>权限对于授权用户，使用权限验证去保护你应用 GraphQL API 的安全。</p>
<p><em>Nhost 的授权服务允许你为你的用户提供无摩擦注册和登录体验。我们支持大量社交账户和不同的方法（无密码、短信等等）</em></p>
<h3 id="插入一个测试用户">插入一个测试用户</h3>
<p>通过你应用顶部菜单的<strong>用户</strong>页签手动创建用户并且点击<strong>增加用户</strong>。</p>
<p><img src="https://docs.nhost.io/images/quick-start/add-user.gif" alt="Add user" loading="lazy" ></p>
<p>你现在将使用新创建的用户向 API 发出授权过的请求.</p>
<h3 id="授权并查询数据">授权并查询数据</h3>
<p>增加下列的代码登录新的用户并且再一次请求一列 todos:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">NhostClient</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@nhost/nhost-js&#34;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nhost</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">NhostClient</span>({
  <span style="color:#a6e22e">backendUrl</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;https://[app-subdomain].nhost.run&#34;</span>,
})(<span style="color:#66d9ef">async</span> () =&gt; {
  <span style="color:#75715e">// Sign in user
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">signInResponse</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">nhost</span>.<span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">signIn</span>({
    <span style="color:#a6e22e">email</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;joe@example.com&#34;</span>,
    <span style="color:#a6e22e">password</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;securepassword&#34;</span>,
  });

  <span style="color:#75715e">// Handle sign-in error
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">signInResponse</span>.<span style="color:#a6e22e">error</span>) {
    <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">signInResponse</span>.<span style="color:#a6e22e">error</span>;
  }

  <span style="color:#75715e">// Get todos
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">todos</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">nhost</span>.<span style="color:#a6e22e">graphql</span>.<span style="color:#a6e22e">request</span>(<span style="color:#e6db74">`
</span><span style="color:#e6db74">    query {
</span><span style="color:#e6db74">      todos {
</span><span style="color:#e6db74">        id
</span><span style="color:#e6db74">        created_at
</span><span style="color:#e6db74">        name
</span><span style="color:#e6db74">        is_completed
</span><span style="color:#e6db74">      }
</span><span style="color:#e6db74">    }
</span><span style="color:#e6db74">  `</span>);

  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">todos</span>.<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">null</span>, <span style="color:#ae81ff">2</span>));
})();
</code></pre></div><p>为什么返回空值？因为当作为授权用户执行 GraphQL 请求时，这个<strong>用户</strong>角色被假定。</p>
<p><em>对于授权请求，总是可以使用其他合法的角色覆盖默认的<strong>用户</strong>角色。</em></p>
<h3 id="用户权限">用户权限</h3>
<p><strong>移除公共角色的权限</strong></p>
<p>我们将不再使用<strong>public</strong>角色，所以，让我们移除这个角色的所有权限。</p>
<p><img src="https://docs.nhost.io/images/quick-start/remove-public-permissions.png" alt="Remove public permissions from Hasura" loading="lazy" ></p>
<p>现在，我们将增加<strong>user</strong>角色权限。</p>
<p><em>所有登录用户都有<strong>user</strong>角色</em></p>
<p><strong>插入权限</strong></p>
<p>首先，我们设置<strong>插入权限</strong>。</p>
<p>一个用户仅能插入<code>name</code>，因为所有的其他列将被自动设置。更具体的说，<code>user_id</code>将被设置为发出请求用户 ID（<code>x-hasura-user-id</code>），并在<strong>Column presets</strong>部分配置。见下图：</p>
<p><img src="https://docs.nhost.io/images/quick-start/user-insert-permission.png" alt="User insert permission" loading="lazy" ></p>
<p><strong>选择权限</strong></p>
<p>对于<strong>选择权限</strong>，设置一个<strong>自定义检查</strong>，以便用户仅能选择<code>user_id</code>与他们用户 ID 相同的 todos。换句话说：用户仅能选择他们自己的 todos。见下图：</p>
<p><img src="https://docs.nhost.io/images/quick-start/user-select-permission.png" alt="User select permission" loading="lazy" ></p>
<p>现在，再一次运行 APP。新的 todos 被插入，并且仅用户的 todos 能被查询和展示。你的后端成功被保护！</p>
<h1 id="4-工作流命令行">4. 工作流命令行</h1>
<h2 id="41-命令行从零到生产环境">4.1 命令行从零到生产环境</h2>
<p>在之前的教程中，我们测试了 Nhost 的各部分，例如：</p>
<ul>
<li>Database</li>
<li>GraphQL API</li>
<li>Permission</li>
<li>JavaScript SDK</li>
<li>Authentication</li>
</ul>
<p>我们为数据库和 API 做的所有更改都直接在 Nhost 应用的生产环境。</p>
<p>在生产环境进行更改是不理想的，因为你或许弄砸事情，将影响应用的所有用户。</p>
<p>反而，在部署这些变更到生产环境之前，更推荐在本地更改和测试应用。</p>
<p>为了在本地进行更改，我们需要有一个完整的 Nhost 应用运行在本地，这是 Nhost CLI 做的事情。</p>
<p>Nhost CLI 在本地环境中匹配生产环境应用，这种方式在部署修改到生产环境前，你可以修改或者测试代码。</p>
<h3 id="使用-nhost-建议的工作流">使用 Nhost 建议的工作流</h3>
<ul>
<li>使用 Nhost CLI 本地开发</li>
<li>推送变更到 GitHub</li>
<li>Nhost 部署变更到生产环境</li>
</ul>
<h3 id="你将在该指导中学到什么">你将在该指导中学到什么：</h3>
<ul>
<li>使用 Nhost CLI 创建本地环境</li>
<li>使用 Nhost 应用连接到 GitHub 仓库</li>
<li>部署本地修改到生产环境</li>
</ul>
<h2 id="42-工作流程设置">4.2 工作流程设置</h2>
<p>接下来是如何为工作流程设置 Nhost 的详细教程。</p>
<h3 id="创建-nhost-应用">创建 Nhost 应用</h3>
<p>为该练习创建新的 Nhost 应用。</p>
<blockquote>
<p>为这个指导创建新的应用而不是复用旧的 Nhost 应用是重要的，因为我们想去起推动一个干净的 Nhost 应用。</p>
</blockquote>
<p><img src="https://docs.nhost.io/images/cli-workflow/create-app.png" alt="Create new app" loading="lazy" ></p>
<h3 id="创建新的-github-仓库">创建新的 GitHub 仓库</h3>
<p>为你的新 Nhost 应用创建新的 GitHub 仓库。仓库私有或者公开都可以。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/create-repo.png" alt="Create new repo" loading="lazy" ></p>
<h3 id="把-github-仓库连接到-nhost-应用">把 GitHub 仓库连接到 Nhost 应用</h3>
<p>在 Nhost 面板，前往你 Nhost 应用的仪表盘并且点击<code>Connect to GitHub</code>。</p>
<p><a href="https://docs.nhost.io/videos/cli-workflow/connect-github-repo.mp4">视频演示</a></p>
<h2 id="43-安装命令行">4.3 安装命令行</h2>
<p>使用下列命令安装 Nhost CLI：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo curl -L https://raw.githubusercontent.com/nhost/cli/main/get.sh | bash
</code></pre></div><p>在本地初始化新的 Nhost 应用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">nhost init -n <span style="color:#e6db74">&#34;nhost-example-app&#34;</span> <span style="color:#f92672">&amp;&amp;</span> cd nhost-example-app
</code></pre></div><p>并且，在相同文件夹初始化 GitHub 仓库：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">echo <span style="color:#e6db74">&#34;# nhost-example-app&#34;</span> &gt;&gt; README.md
git init
git add README.md
git commit -m <span style="color:#e6db74">&#34;first commit&#34;</span>
git branch -M main
git remote add origin https://github.com/<span style="color:#f92672">[</span>github-username<span style="color:#f92672">]</span>/nhost-example-app.git
git push -u origin main
</code></pre></div><p>现在返回 Nhost 面板，点击<code>Deployments</code>。你就已经为 Nhost 应用完成了新的部署。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/deployments-tab.png" alt="Deployments tab" loading="lazy" ></p>
<p>如果你点击部署，你可以看到没有任何东西真的部署了。因为，我们仅仅对 README 文件做了变更。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/deployments-details.png" alt="Deployments details" loading="lazy" ></p>
<p>让我们做一些本地后端的变更吧！</p>
<h2 id="44-本地变更">4.4 本地变更</h2>
<p>本地启动 Nhost：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">nhost dev
</code></pre></div><blockquote>
<p>确保你已经在自己电脑上安装了 Docker。这是 Nhost 工作所必须的。</p>
</blockquote>
<p><code>nhost dev</code> 命令将在你的电脑上自动开始一个完整的本地 Nhost 环境：</p>
<ul>
<li>Postgres</li>
<li>Hasura</li>
<li>Authentication</li>
<li>Storage</li>
<li>Serverless Functions</li>
<li>Mailhog</li>
</ul>
<p>在部署变更到生产环境前，你使用本地环境去做更改和测试。</p>
<p>运行<code>nhost dev</code> 也启动 Hasura 控制面板。</p>
<blockquote>
<p>使用 Hasura 面板是重要的，当你变更时，它自动启动。这种方式，自动为你跟踪变化。</p>
</blockquote>
<p><img src="https://docs.nhost.io/images/cli-workflow/hasura-console.png" alt="Hasura Console" loading="lazy" ></p>
<p>在 Hasura 控制面板，创建一个带有 2 列的新表<code>customers</code>:</p>
<ul>
<li>id</li>
<li>name</li>
</ul>
<p><a href="https://docs.nhost.io/videos/cli-workflow/hasura-create-customers-table.mp4">视频演示</a></p>
<p>当我们创建<code>customers</code>表时，有一个迁移被自动创建。迁移被创建在 <code>nhost/migrations/default</code>下。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ls -la nhost/migrations/default
total <span style="color:#ae81ff">0</span>
drwxr-xr-x  <span style="color:#ae81ff">3</span> eli  staff   <span style="color:#ae81ff">96</span> Feb  <span style="color:#ae81ff">7</span> 16:19 .
drwxr-xr-x  <span style="color:#ae81ff">3</span> eli  staff   <span style="color:#ae81ff">96</span> Feb  <span style="color:#ae81ff">7</span> 16:19 ..
drwxr-xr-x  <span style="color:#ae81ff">4</span> eli  staff  <span style="color:#ae81ff">128</span> Feb  <span style="color:#ae81ff">7</span> 16:19 1644247179684_create_table_public_customers
</code></pre></div><p>数据库迁移或许仅被应用于本地，意味着，你在本地创建<code>customers</code>表，但是它至今不存在于生产环境。</p>
<p>为了将本地变更应用到生产环境，我们需要提交变更，并且推送它到 GitHub。Nhost 将自动获取仓库变更并应用变更。</p>
<blockquote>
<p>你可以提交和推送文件在另一个终端，以便<code>nhost dev</code>仍然运行。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git add -A
git commit -m <span style="color:#e6db74">&#34;Initialized Nhost and added a customers table&#34;</span>
git push
</code></pre></div><p>在 Hasura 面板导航到<code>Deployments</code>选项卡看下部署。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/deployments-tab-with-changes.png" alt="Deployments tab after changes" loading="lazy" ></p>
<p>一旦部署完成，<code>customers</code>表将在生产环境创建。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/hasura-customers-table.png" alt="Customers table in Hasura Console" loading="lazy" ></p>
<p>现在，我们在 Nhost 完成了推荐的工作流：</p>
<ul>
<li>使用 Nhost CLI 本地开发</li>
<li>推送变更到 GitHub</li>
<li>Nhost 部署变更到生产环境</li>
</ul>
<h2 id="45-元数据和-serverless-函数">4.5 元数据和 Serverless 函数</h2>
<p>在上述章节，我们仅仅创建了一个新的表：<code>customers</code>。使用命令行你也可以后端的其他部分。</p>
<p>命令行和 GitHub 集成跟踪和应用到生产环境有有 3 个事情：</p>
<ul>
<li>数据迁移</li>
<li>Hasura 元数据</li>
<li>Serverless 函数</li>
</ul>
<p>本节，我们变更下 Hasura 元数据并且创建一个 Serverless 函数。</p>
<h3 id="hasura-元数据">Hasura 元数据</h3>
<p>我们为<code>users</code>表增加权限，确保用户仅能看到他们自己的数据。为此，前往<code>auth</code>模式，点击<code>users</code>表。然后点击 <code>Permissions</code> 并键入新的角色 <code>user</code>，并且为角色创建新的 <code>select</code> 权限。</p>
<p>使用<code>自定义检查</code>创建权限：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JSON" data-lang="JSON">{
  <span style="color:#f92672">&#34;id&#34;</span>: {
    <span style="color:#f92672">&#34;_eq&#34;</span> : <span style="color:#e6db74">&#34;X-Hasura-User-Id&#34;</span>
  }
}
</code></pre></div><p>选择下列的字段：</p>
<ul>
<li>id</li>
<li>created_at</li>
<li>display_name</li>
<li>avatar_url</li>
<li>email</li>
</ul>
<p>然后点击<code>Save permissions</code>(保存权限)。</p>
<p><a href="https://docs.nhost.io/videos/cli-workflow/hasura-user-permissions.mp4">视频演示</a></p>
<p>现在，我们再做一次<code>git status</code>(git 状态检查)去确保我们做的权限更改被跟踪到本地的 Git 仓库中。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/git-status.png" alt="Git status" loading="lazy" ></p>
<p>我们现在可以提交该变更：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git add -A
git commit -m <span style="color:#e6db74">&#34;added permission for uses&#34;</span>
</code></pre></div><p>现在，让我们在推送所有变更到 GitHub 之前，创建一个 serverless 函数，以便 Nhost 能部署我们的变更。</p>
<h3 id="serverless-函数">Serverless 函数</h3>
<p>Serverless 函数是一块用 JavaScript 或者 TypeScript 写的代码，它能响应 http 请求，并返回响应。</p>
<p>这是一些示例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">Response</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;express&#34;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> (<span style="color:#a6e22e">req</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">res</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Response</span>) =&gt; {
  <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">200</span>).<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">`Hello </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">!`</span>);
};
</code></pre></div><p>Serverless 函数被放置在仓库的<code>functions/ </code>文件夹。每个文件变成他自己的端点。在我们创建 serverless 函数之前，需要安装 <code>express</code>，它是 Serverless 函数工作的必要条件。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install express
<span style="color:#75715e"># or with yarn</span>
yarn add express
</code></pre></div><p>我们将用到 TypeScript，所以我们也安装两个类型定义。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install -d @types/node @types/express
<span style="color:#75715e"># or with yarn</span>
yarn add -D @types/node @types/express
</code></pre></div><p>然后，我们创建一个文件 <code>functions/time.ts</code>。</p>
<p>在文件 <code>time.ts</code> 中，我们将增加下列的代码去创建我们的 serverless 函数:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">Response</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;express&#34;</span>;

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> (<span style="color:#a6e22e">req</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">res</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Response</span>) =&gt; {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>
    .<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">200</span>)
    .<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">`Hello </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">! It&#39;s now: </span><span style="color:#e6db74">${</span><span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toUTCString</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
};
</code></pre></div><p>我们现在可以在本地测试该函数。本地，后端 URL 是 <code>http://localhost:1337</code>。函数位于<code>/v1/functions </code>之下。每个函数的路径和名称变成 API 端点。</p>
<p>这意味着我们的函数<code>functions/time.ts</code>位于 <code>http://localhost:1337/v1/functions/time</code>.</p>
<p>让我们使用 curl 测试我们的新函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl http://localhost:1337/v1/functions/time
Hello undefined! It<span style="color:#960050;background-color:#1e0010">&#39;</span>s now: Sun, <span style="color:#ae81ff">06</span> Feb <span style="color:#ae81ff">2022</span> 17:44:45 GMT
</code></pre></div><p>并且携带一个带有我们名字的查询参数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl http://localhost:1337/v1/functions/time<span style="color:#ae81ff">\?</span>name<span style="color:#ae81ff">\=</span>Johan
Hello Johan! It<span style="color:#960050;background-color:#1e0010">&#39;</span>s now: Sun, <span style="color:#ae81ff">06</span> Feb <span style="color:#ae81ff">2022</span> 17:44:48 GMT
</code></pre></div><p>再一次，让我们使用<code>git status</code>去看下创建过 serverless 函数后的变化。</p>
<p>现在，提交变化并且推送到 GitHub。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git add -A
git commit -m <span style="color:#e6db74">&#34;added serverless function&#34;</span>
git push
</code></pre></div><p>在 Nhost 控制面板，点击一个新的部署看下详情。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/details-for-function.png" alt="Deployments details for function" loading="lazy" ></p>
<p>Nhost 完成变更部署后，我们可以在生产环境测试他们。首先，确保用户权限已经应用。</p>
<p><img src="https://docs.nhost.io/images/cli-workflow/hasura-permissions-table.png" alt="Hasura Console permissions table" loading="lazy" ></p>
<p>然后，确认 serverless 函数被部署。再一次，我们使用 curl:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl http://localhost:1337/v1/functions/time<span style="color:#ae81ff">\?</span>name<span style="color:#ae81ff">\=</span>Johan
</code></pre></div><p><img src="https://docs.nhost.io/images/cli-workflow/function-test.png" alt="Serverless Function test" loading="lazy" ></p>
<h3 id="结论">结论</h3>
<p>在这个练习中，我们安装了 Nhost CLI 并且创建了本地 Nhost 环境进行本地开发和测试。</p>
<p>在本地环境中，我们变更了数据库和 Hasura’s 元数据，并且创建了 serverless 函数。</p>
<p>我们连接到 GitHub 仓库，并且推送变更到 GitHub。</p>
<p>我们看到了 Nhost 自动部署我们的变更，并且我们验证了更改的应用。</p>
<p>总结，我们使用推荐的 Nhost 工作流建立了生产环境：</p>
<ul>
<li>使用 Nhost CLI 本地开发</li>
<li>推送变更到 GitHub</li>
<li>Nhost 部署变更到生产环境</li>
</ul>
<h1 id="4-从-v1-升级到-v2待润色">4. 从 V1 升级到 V2(待润色)</h1>
<p>从 Nhost V1 版本升级到 V2 版本需要改变数据库 schema 和 hasura 元数据。</p>
<p><strong>需要帮助？</strong></p>
<p>如果你需要帮助从 V1 迁移到 V2,请联系 Johan: <a href="mailto:johan@nhost.io">johan@nhost.io</a></p>
<h3 id="升级步骤">升级步骤</h3>
<p><strong>准备一个新的文件夹</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir -p nhost-v2/nhost
echo <span style="color:#e6db74">&#34;version: 2&#34;</span> &gt; nhost-v2/nhost/config.yaml
</code></pre></div><p><strong>导出 Nhost V1 的当前迁移和元数据</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">hasura migrate create init --from-server --endpoint<span style="color:#f92672">=[</span>v1-endpoint<span style="color:#f92672">]</span> --admin-secret<span style="color:#f92672">=[</span>v1-admin-secret<span style="color:#f92672">]</span>
hasura metadata export --endpoint<span style="color:#f92672">=[</span>v1-endpoint<span style="color:#f92672">]</span> --admin-secret<span style="color:#f92672">=[</span>v1-admin-secret<span style="color:#f92672">]</span>
</code></pre></div><p><strong>编辑迁移</strong></p>
<p>编辑被创建的<em>up.sql</em>迁移文件。</p>
<ul>
<li>删除所有*auth.**表和函数</li>
<li>删除<em>public.users</em>表</li>
<li>更新外键引用从<em>public.users</em>到<em>auth.users</em></li>
<li>Add OR REPLACE after CREATE for the public.set_current_timestamp_updated_at function</li>
</ul>
<p><strong>编辑元数据</strong>
更新元数据</p>
<ul>
<li>在<em>auth</em> schema 中删除所有跟踪的所有表</li>
<li>删除跟踪<em>public.users</em>表</li>
<li>更新对用户的所有从<em>public</em>到<em>auth</em> schema 的引用</li>
</ul>
<p><em>启动 nhost</em>
启动 Nhost CLI</p>
<p><em>重启授权和存储容器</em></p>
<p>打开 Docker UI 并重启 Hasura Auth 和 Hasura Storage。这将 为 auth 和 storage schema 重新应用数据库库迁移和元数据。</p>
<p><em>移动数据库迁移</em></p>
<p>移动当前<em>migrations</em>文件夹到前一个<em>migration-bk</em></p>
<p><em>更改配置版本</em></p>
<p>更改配置版本从<em>config 2</em>到<em>config 3</em>在<em>nhost/config.yaml</em>文件</p>
<p><em>导出本地元数据用新的格式</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">hasura metadata export --endpoint<span style="color:#f92672">=</span>http://localhost:1337 --admin-secret<span style="color:#f92672">=</span>nhost-admin-secret
</code></pre></div><p><strong>移动迁移文件夹</strong>
为了匹配 hasura 配置 V3,移动所有的迁移进入<em>migrations/default</em>文件夹。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir -p migrations/default
cp -r migrations/* migrations/default/
</code></pre></div><p><strong>完成</strong>
数据库迁移和元数据现在从远程 Nhost V1 的后端拉取下来了，为 Nhost V2 编辑，并且为 Hasura Configuration v3 更新。</p>

    </div>

    <div class="post-copyright">
            
            <p class="copyright-item">
                <span>Author:</span>
                <span>Anson </span>
                </p>
            


            
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=http://ansoncode.bazhentu.net/2022/002-%E8%AF%91-nohost%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BD%BF%E7%94%A8/>http://ansoncode.bazhentu.net/2022/002-%E8%AF%91-nohost%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BD%BF%E7%94%A8/</span>
            </p>
            
            
            <div id="qr_code_pc_outer" >
                <img src=https://api.qrserver.com/v1/create-qr-code/?size&#61;150x150&amp;data&#61;http://ansoncode.bazhentu.net/2022/002-%E8%AF%91-nohost%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BD%BF%E7%94%A8/>
                <p>扫一扫<br>阅读文章</p>
            </div>
            <script>
                if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
                    
                    
                    
                }else{
                    document.getElementById('qr_code_pc_outer').style.display="block"
                }
            </script>
            <style> 
            p { word-wrap:break-word; }
                #qr_code_pc_outer {
                    display: none;
                    color: #717375;
                     
                    position: fixed;
                    right: 100px;
                    text-align: center;
                    top: 200px;
                    }
                #qr_code_pc_outer img{
                    width: 100px;height: 100px;
                }
                #qr_code_pc_outer p{
                    font-size: 0.5em;
                }
            </style>
            
            
            <p class="copyright-item">
                <span>Expect:</span>
                <span>专注云开发相关技术及产品，寻找合作机会 </span>
                </p>
            
            
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>


    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s):
            
            <span class="tag"><a href="http://ansoncode.bazhentu.net/tags/%E6%8A%80%E6%9C%AF%E7%BF%BB%E8%AF%91/">
                    #技术翻译</a></span>
            
            <span class="tag"><a href="http://ansoncode.bazhentu.net/tags/hasura/">
                    #Hasura</a></span>
            
            <span class="tag"><a href="http://ansoncode.bazhentu.net/tags/nhost/">
                    #Nhost</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> ·
                <span><a href="http://ansoncode.bazhentu.net/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="http://ansoncode.bazhentu.net/2022/001-%E8%AF%91-hasura%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/" class="prev" rel="prev" title="001 译 | Hasura设计思想"><i class="iconfont icon-left"></i>&nbsp;001 译 | Hasura设计思想</a>
        
        
        <a href="http://ansoncode.bazhentu.net/2022/003-%E8%AF%91-graphql%E5%88%B0sql%E9%AB%98%E6%80%A7%E8%83%BD%E6%9E%B6%E6%9E%84/" class="next" rel="next" title="003 译 | GraphQL到SQL高性能架构">003 译 | GraphQL到SQL高性能架构&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
            
                <div id="tcomment"></div>
<script src="https://cdn.jsdelivr.net/npm/twikoo@1.0.0/dist/twikoo.all.min.js"></script>
<script>twikoo.init({ envId: 'anson-blog-talk-8gwaudnw7b5c558b', el: '#tcomment' })</script>
            
        
    </div>
</article>
                </div>
            </main>
            <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2017 - 2022</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i>
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="http://ansoncode.bazhentu.net/">Anson</a> | </span>
         

         
            <a href="http://www.miibeian.gov.cn/" target="_blank" rel="external nofollow">陕ICP备17023607号-1 </a> |
         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/Mogeko/Mogege" target="_blank" rel="external nofollow">Mogege</a></span>
    </div>
</footer>








<script defer src="/js/vendor_main.min.js"></script>







<script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script> pangu.spacingPage();</script>






  <script>
    
    function loadJs(url) {
        return new Promise((resolve, reject) => {
            var script = document.createElement('script');
            script.type = "text/javascript";
            if (script.readyState) {
                script.onreadystatechange = function () {
                    if (script.readyState == "loaded" || script.readyState == "complete") {
                        script.onreadystatechange = null;
                        
                        resolve()
                    }
                }
            } else {
                script.onload = function () {
                    
                    resolve()
                }
            }
            script.src = url;
            document.body.appendChild(script);
        })

    }
    function loadManyJs(arr) {
        return new Promise(async (resolve, reject) => {
            for (let i = 0; i < arr.length; i++) {
                let jsUrl = arr[i]
                try {
                    await loadJs(jsUrl)
                } catch (error) {
                    reject(error)
                }
            }
            resolve()
        })
    }

    
    var currurl = location.href.split('#')[0]
    let userAgent = navigator.userAgent.toLowerCase();
    let isWeixin = userAgent.match(/MicroMessenger/i) == "micromessenger"
    let isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
    let arr = [
        "//astyle-src.alicdn.com/app/searchweb/products/zhaohuoshenqi/lib/jquery.js",
        "//res.wx.qq.com/open/js/jweixin-1.6.0.js"
    ]
    if (isMobile) {
        
        loadManyJs(arr).then(async () => {
            console.log('仅微信端需要执行下面的操作', currurl)
            let title = '002 译 | Nhost简介及使用'
            console.log('title', title)
            let desc = 'anson会写代码的产品经理，这是我的技术博客，专注产品设计及软件开发。'
            let imgUrl =  "https://ansoncode.bazhentu.net/myblogtalk/img/PfjiWupdZrtzINV.png" 
            

            let link =  "https://wechat-mp-8geeep1wd1373392-1253693669.ap-shanghai.app.tcloudbase.com/koa-starter/getSign"
            let data = await JQ.get(link, { url: currurl })
            console.log(data)
            
            
            
            
            
            
            let debug= false 
            wx.config({
                debug: debug, 
                appId: data.appId, 
                timestamp: data.timestamp, 
                nonceStr: data.nonceStr, 
                signature: data.signature,
                jsApiList: ["checkJsApi", "updateAppMessageShareData", "onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareQZone"] 
            });
  
            wx.ready(function () {
                
                wx.checkJsApi({
                    jsApiList: ["checkJsApi", "updateAppMessageShareData", "onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareQZone"], 
                    success: function (res) {
                        
                        
                        
                        
                    }
                });
                
                wx.updateAppMessageShareData({
                    title: title, 
                    desc: desc, 
                    link: currurl, 
                    imgUrl: imgUrl, 
                    success: function () {
                        
                    }
                })
                
                
                
                
                
                
                
                
                
                
                
                wx.onMenuShareTimeline({
                    title: title, 
                    desc: desc, 
                    link: currurl, 
                    imgUrl: imgUrl, 
                    success: function (res) {
                    },
                    cancel: function (res) {
                    },
                    fail: function (res) {
                        alert(JSON.stringify(res));
                    }
                });
                
                wx.onMenuShareAppMessage({
                    title: title, 
                    desc: desc, 
                    link: currurl, 
                    imgUrl: imgUrl, 
                    type: '', 
                    dataUrl: '', 
                    success: function () {
                        
                    },
                    cancel: function () {
                        
                    }
                });
                
                wx.onMenuShareQQ({
                    title: title, 
                    desc: desc, 
                    link: currurl, 
                    imgUrl: imgUrl, 
                    success: function () {
                        
                    },
                    cancel: function () {
                        
                    }
                });
                
                wx.onMenuShareQZone({
                    title: title, 
                    desc: desc, 
                    link: currurl, 
                    imgUrl: imgUrl, 
                    success: function () {
                        
                    },
                    cancel: function () {
                        
                    }
                });

            });
            wx.error(function (res) {
                
                console.log("初始化wx.config失败" + res)
            });
        }).catch(err => {
            console.log('load js error', err)
        })
    }


</script>


        </div>
    </body>
</html>
